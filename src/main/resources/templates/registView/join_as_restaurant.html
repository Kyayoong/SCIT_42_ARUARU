<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">
<head>
<meta charset="UTF-8">
<script th:src="@{/js/jquery-3.6.0.min.js}"></script>
<link th:href="@{/css/registCss.css}" rel="stylesheet">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
<script
	src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js">
	
</script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js">
	
</script>
<script>
	$(document).ready(function()
	// input file 파일 첨부시 fileCheck 함수 실행
	{
		$("#input_file").on("change", fileCheck);
	});

	/**
	 * 첨부파일로직
	 */
	$(function() {
		$('#btn-upload').click(function(e) {
			e.preventDefault();
			$('#input_file').click();
		});
	});

	// 파일 현재 필드 숫자 totalCount랑 비교값
	var fileCount = 0;
	// 해당 숫자를 수정하여 전체 업로드 갯수를 정한다.
	var totalCount = 10;
	// 파일 고유넘버
	var fileNum = 0;
	// 첨부파일 배열
	var content_files = new Array();

	function fileCheck(e) {
		var files = e.target.files;

		// 파일 배열 담기
		var filesArr = Array.prototype.slice.call(files);

		// 파일 개수 확인 및 제한
		if (fileCount + filesArr.length > totalCount) {
			$.alert('파일은 최대 ' + totalCount + '개까지 업로드 할 수 있습니다.');
			return;
		} else {
			fileCount = fileCount + filesArr.length;
		}

		// 각각의 파일 배열담기 및 기타
		filesArr
				.forEach(function(f) {
					var reader = new FileReader();
					reader.onload = function(e) {
						content_files.push(f);
						$('#articlefileChange')
								.append(
										'<div id="file'
												+ fileNum
												+ '" onclick="fileDelete(\'file'
												+ fileNum
												+ '\')">'
												+ '<font style="font-size:12px">'
												+ f.name
												+ '</font>'
												+ '<img src="../images/xxxxx.png" style="width:20px; height:auto; vertical-align: middle; cursor: pointer;"/>'
												+ '<div/>');
						fileNum++;
					};
					reader.readAsDataURL(f);
				});
		console.log(content_files);
		//초기화 한다.
		$("#input_file").val("");
	}

	// 파일 부분 삭제 함수
	function fileDelete(fileNum) {
		var no = fileNum.replace(/[^0-4]/g, "");
		content_files[no].is_delete = true;
		$('#' + fileNum).remove();
		fileCount--;
		console.log(content_files);
	}

	/*
	 * 폼 submit 로직
	 */
	function registerAction() {

		var form = $("form")[0];
		var formData = new FormData(form);
		for (var x = 0; x < content_files.length; x++) {
			// 삭제 안한것만 담아 준다. 
			if (!content_files[x].is_delete) {
				formData.append("article_file", content_files[x]);
			}
		}
		/*
		 * 파일업로드 multiple ajax처리
		 */
		$.ajax({
			type : "POST",
			enctype : "multipart/form-data",
			url : "/file-upload",
			data : formData,
			processData : false,
			contentType : false,
			success : function(data) {
				if (JSON.parse(data)['result'] == "OK") {
					alert("파일업로드 성공");
				} else
					alert("서버내 오류로 처리가 지연되고있습니다. 잠시 후 다시 시도해주세요");
			},
			error : function(xhr, status, error) {
				alert("서버오류로 지연되고있습니다. 잠시 후 다시 시도해주시기 바랍니다.");
				return false;
			}
		});
		return false;
	}
</script>
<title>[ 식당 등록 ]</title>
</head>
<body>
	<!-- 네이게이션 바 -->
	<nav id="navbar" class="navbar navbar-expand-sm bg-light">
		<ul class="navbar-nav">
			<li class="nav-item"><a class="nav-link"  th:href="@{/}">HOME</a>
		</ul>
		<ul class="navbar-nav ml-auto">
			<li class="nav-item"><a class="nav-link" href="#">ABOUT US</a></li>
			<li class="nav-item"><a class="nav-link"
				th:href="@{/user/login}">LOGIN</a></li>
			<li class="nav-item"><a class="nav-link"
				th:href="@{/user/joinselect}">JOIN</a></li>
		</ul>
	</nav>

	<!-- 식당 등록 폼 -->
	<div id="registform">
		<div id="rrmarkarea">
			<img id="rrmark" th:src="@{../images/rrmark.png}"> <img
				id="rrjapanesemark" th:src="@{../images/rrjapanesemark.png}">
			<div id="inform-restaurant-register">
				<p style="font-family: IBM Plex Sans KR;">식당 등록 화면입니다.</p>
			</div>
		</div>
		<!-- 식당 등록 테이블 -->
		<div id="registtable">
			<form th:action="@{/restaurant/regist1}" enctype="multipart/form-data" method="post">
				<table>
					<tr>
						<td><label for="restaurant_name"
							style="font-family: IBM Plex Sans KR;">식당 명을 입력해주세요.</label><br>
							<input class="form-control" type="text" id="nametext"
							name="restaurant_name" style="width: 600px;"
							placeholder="식당 이름을 입력하세요"></td>
					</tr>
					<tr>
						<td><label for="restaurant_ename"
							style="font-family: IBM Plex Sans KR;">식당 이름(영어)</label><br>
							<input class="form-control" type="text" id="restaurant_ename"
							name="restaurant_ename" style="width: 600px;"
							placeholder="식당 영문명을 입력하세요"></td>
					</tr>
					<tr>
						<td><label for="sectors"
							style="font-family: IBM Plex Sans KR;">업종선택</label><br> <select
							class="form-control" id="sectors" name="sectors">
								<option value="koreanfood">한식(韓食)</option>
								<option value="chinesefood">중식(中食)</option>
								<option value="Japanesefood">일식(和食)</option>
								<option value="western food">양식(洋食)</option>
								<option value="baking">제과제빵(ベーキング)</option>
								<option value="pub">주점(さかや)</option>
								<option value="fastfood">패스트푸드(ファーストフード)</option>
								<option value="schoolfood">분식(粉物)</option>
								<option value="ice">아이스크림/빙수(アイスクリーム/かき氷)</option>
								<option value="pizza">피자(ピザ)</option>
								<option value="drink">음료(飲み物)</option>
								<option value="chicken">치킨(チキン)</option>
								<option value="coffee">커피(コーヒー)</option>
						</select></td>
					</tr>
					<tr>
						<td><label for="fffle" style="font-family: IBM Plex Sans KR;">업체
								사진</label><br>
							<button class="btn btn-primary" id="btn-upload" type="button">파일
								추가</button> <input id="input_file" multiple="multiple" type="file"
							style="display: none;"> <span
							style="font-family: IBM Plex Sans KR;">※첨부파일은 최대 5개까지 등록이
								가능합니다.</span>
							<div class="data_file_txt" id="data_file_txt"
								style="margin: 40px;">
								<span>첨부 파일을 등록해주세요.(image파일만 가능)</span> <br>
								<div id="articlefileChange"></div>
							</div>
						<td>
					</tr>

					<tr>
						<td class="contents"><label for="contents"
							style="font-family: IBM Plex Sans KR;">업체 설명</label> <br> <textarea
								class="form-control" rows="3" cols="50" name="contents"
								id="contents">우리 업체를 고객들에게 상세히 설명해주세요.</textarea></td>
					</tr>
					<tr>
						<td style="width: 600px;"><label for="tag1">태그</label><br>
							<div class="btn-group-toggle" data-toggle="buttons">
								<label class="btn btn-outline-secondary" for="tag1"><input
									name="member_tags" value="한식" type="checkbox" id="tag1">한식</label>
							</div>
							<div id="idtag2" class="btn-group-toggle" data-toggle="buttons">
								<label class="btn btn-outline-secondary" for="tag2"><input
									name="member_tags" value="양식" type="checkbox" id="tag2">양식</label>
							</div>
							<div id="idtag3" class="btn-group-toggle" data-toggle="buttons">
								<label class="btn btn-outline-secondary" for="tag3"><input
									name="member_tags" value="일식" type="checkbox" id="tag3">일식</label>
							</div>
							<div id="idtag4" class="btn-group-toggle" data-toggle="buttons">
								<label class="btn btn-outline-secondary" for="tag4"><input
									name="member_tags" value="중식" type="checkbox" id="tag4">중식</label>
							</div>
							<div id="idtag5" class="btn-group-toggle" data-toggle="buttons">
								<label class="btn btn-outline-secondary" for="tag5"><input
									name="member_tags" value="동남아요리" type="checkbox" id="tag5">동남아요리</label>
							</div>
							<div id="idtag6" class="btn-group-toggle" data-toggle="buttons">
								<label class="btn btn-outline-secondary" for="tag6"><input
									name="member_tags" value="뷔페" type="checkbox" id="tag6">뷔페</label>
							</div></td>
					</tr>
					<tr>
						<td><label for="restaurant_phone"
							style="font-family: IBM Plex Sans KR;">전화번호를 입력해주세요.</label><br>
							<select class="form-control" id="restaurant_phone1"
							name="restaurant_phone1" style="width: 100px;">
								<option value="02">02</option>
								<option value="031">031</option>
								<option value="070">070</option>
						</select>
							<div id="form-phone2">
								<input class="form-control" style="width: 500px;" type="text"
									id="restaurant_phone2" name="restaurant_phone2"
									placeholder="식당 번호 입력(-포함)">
							</div></td>
					</tr>
					<tr>
						<td><label for="restaurant_address1"
							style="font-family: IBM Plex Sans KR;">주소를 입력해주세요</label><br>
							<input class="form-control" type="text" id="restaurant_address1"
							name="restaurant_address1" placeholder="주소" style="width: 450px;"
							readonly="readonly">
						<div id="b-search-address">
								<input style="width: 7vw;" class="form-control" type="button"
									onclick="sample5_execDaumPostcode()" value="주소 검색">
							</div> <input class="form-control" type="text" id="restaurant_address2"
							name="restaurant_address2" placeholder="상세주소"
							style="width: 600px;">
							<div id="map"
								style="width: 500px; height: 300px; margin-top: 10px; display: none"></div>

							<script
								src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
							<script
								src="//dapi.kakao.com/v2/maps/sdk.js?appkey=ec51d65c955ff63b6c2b3f36b4898281&libraries=services"></script>
							<script>
								var mapContainer = document
										.getElementById('map'), // 지도를 표시할 div
								mapOption = {
									center : new daum.maps.LatLng(37.537187,
											127.005476), // 지도의 중심좌표
									level : 5
								// 지도의 확대 레벨
								};

								//지도를 미리 생성
								var map = new daum.maps.Map(mapContainer,
										mapOption);
								//주소-좌표 변환 객체를 생성
								var geocoder = new daum.maps.services.Geocoder();
								//마커를 미리 생성
								var marker = new daum.maps.Marker({
									position : new daum.maps.LatLng(37.537187,
											127.005476),
									map : map
								});

								function sample5_execDaumPostcode() {
									new daum.Postcode(
											{
												oncomplete : function(data) {
													var addr = data.address; // 최종 주소 변수

													// 주소 정보를 해당 필드에 넣는다.
													document
															.getElementById("restaurant_address1").value = addr;
													// 주소로 상세 정보를 검색
													geocoder
															.addressSearch(
																	data.address,
																	function(
																			results,
																			status) {
																		// 정상적으로 검색이 완료됐으면
																		if (status === daum.maps.services.Status.OK) {

																			var result = results[0]; //첫번째 결과의 값을 활용

																			// 해당 주소에 대한 좌표를 받아서
																			var coords = new daum.maps.LatLng(
																					result.y,
																					result.x);
																			// 지도를 보여준다.
																			mapContainer.style.display = "block";
																			map
																					.relayout();
																			// 지도 중심을 변경한다.
																			map
																					.setCenter(coords);
																			// 마커를 결과값으로 받은 위치로 옮긴다.
																			marker
																					.setPosition(coords)
																		}
																	});
												}
											}).open();
								}
							</script></td>
					</tr>
					<tr>
						<td>
							<p></p>
						</td>
					</tr>
				</table>
				<!-- 전송 ajax로 보낼거임~-->
				<div id="registerbuttondiv">
					<input type="submit" id="bt1" onclick="clkBtn()" style="font-family: IBM Plex Sans KR;"
						class="btn btn-primary" value="등록">
				</div>
				<br>
			</form>
		</div>
	</div>
	<!-- 공백용 -->
	<div id="empty">
		<p></p>
	</div>
</body>
</html>